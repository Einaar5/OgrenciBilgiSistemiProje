@model List<OgrenciBilgiSistemiProje.Models.Attendance>

@{
    Layout = "~/Views/Shared/_LayoutTeacher.cshtml";
}

<h2>Devamsızlık Girişi</h2>

<!-- Debug bilgisi -->
@if (TempData["DebugMessage"] != null)
{
    <div class="alert alert-info">@TempData["DebugMessage"]</div>
}

<!-- Hata veya uyarı mesajları -->
@if (TempData["WarningMessage"] != null)
{
    <div class="alert alert-warning">@TempData["WarningMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}

<!-- Ders seçimi -->
<form asp-action="Attendance" method="get">
    <div class="d-flex align-items-center gap-4">
        <label for="lessonId" class="">Ders Seçin:</label>
        <select class="form-select w-75" name="lessonId" onchange="this.form.submit()">
            <option value="0">Bir ders seçin</option>
            @foreach (var lesson in ViewBag.Lessons)
            {
                <option value="@lesson.Value" selected="@(lesson.Value == ViewBag.SelectedLessonId.ToString())">@lesson.Text</option>
            }
        </select>
    </div>
</form>

<!-- Öğrencileri derse kaydet butonu -->
@if (ViewBag.SelectedLessonId != null && ViewBag.SelectedLessonId != 0)
{
    <div class="mt-3 mb-2">
        <form asp-action="RegisterStudentsToLesson" method="post">
            <input type="hidden" name="lessonId" value="@ViewBag.SelectedLessonId" />
            <button type="submit" class="btn btn-danger">Bölüm Öğrencilerini Derse Kaydet</button>
        </form>
    </div>
}

<!-- Tarih seçimi ve devamsızlık girişi -->
@if (Model.Any())
{
    <div class="mt-3">
        <form asp-action="Attendance" method="get">
            <input type="hidden" name="lessonId" value="@Model[0].LessonId" />
            <label for="attendanceDate">Tarih Seçin:</label>
            <input type="date" name="attendanceDate" value="@(((DateTime)ViewBag.SelectedDate).ToString("yyyy-MM-dd"))" onchange="this.form.submit()" />
        </form>
    </div>

    <form asp-action="Attendance" method="post">
        <input type="hidden" name="attendances[0].LessonId" value="@Model[0].LessonId" />
        <input type="hidden" name="attendances[0].AttendanceDate" value="@Model[0].AttendanceDate.ToString("yyyy-MM-dd")" />
        <table class="table">
            <thead>
                <tr>
                    <th>Öğrenci Adı</th>
                    <th>1. Saat</th>
                    <th>2. Saat</th>
                    <th>3. Saat</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.Count; i++)
                {
                    <tr>
                        <td>
                            @(Model[i].Student != null
                                ? $"{Model[i].Student.StudentName} {Model[i].Student.StudentSurname}"
                                : "Öğrenci Bilgisi Yok")
                        </td>
                        <td>
                            <input type="checkbox" name="attendances[@i].IsComeHour1" value="true"
                            @(Model[i].IsComeHour1 ? "checked" : "") />
                            <input type="hidden" name="attendances[@i].IsComeHour1" value="false" />
                        </td>
                        <td>
                            <input type="checkbox" name="attendances[@i].IsComeHour2" value="true"
                            @(Model[i].IsComeHour2 ? "checked" : "") />
                            <input type="hidden" name="attendances[@i].IsComeHour2" value="false" />
                        </td>
                        <td>
                            <input type="checkbox" name="attendances[@i].IsComeHour3" value="true"
                            @(Model[i].IsComeHour3 ? "checked" : "") />
                            <input type="hidden" name="attendances[@i].IsComeHour3" value="false" />
                        </td>
                        <td>
                            <input type="hidden" name="attendances[@i].StudentId" value="@Model[i].StudentId" />
                            <input type="hidden" name="attendances[@i].LessonId" value="@Model[i].LessonId" />
                            <input type="hidden" name="attendances[@i].AttendanceDate" value="@Model[i].AttendanceDate.ToString("yyyy-MM-dd")" />
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <button type="submit" class="btn btn-danger">Kaydet</button>
    </form>
}

<!-- Devamsızlık Raporu Tablosu -->
@if (ViewBag.SelectedLessonId != null && ViewBag.SelectedLessonId != 0 && ViewBag.AbsenceReport != null )
{
    <div class="mt-5">
        <h3>Devamsızlık Raporu</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Öğrenci Adı</th>
                    <th>Toplam Devamsızlık (Saat)</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var report in ViewBag.AbsenceReport)
                {
                    <tr>
                        <td>@report.StudentName</td>
                        <td>@report.AbsenceCount</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}